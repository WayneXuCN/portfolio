name: è‡ªåŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨

on:
  push:
    branches: [main]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼Œå¢åŠ æ§åˆ¶

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production # ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒ
    concurrency: production # é˜²æ­¢å¹¶å‘éƒ¨ç½²

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # æµ…å…‹éš†ï¼Œæé«˜é€Ÿåº¦

      - name: æœåŠ¡å™¨æ‰§è¡Œæ‹‰å–å‘½ä»¤
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
            cd /opt/1panel/apps/openresty/openresty/www/sites/wenjiexusite/index

            # è®¾ç½®ä»£ç†åŠ é€Ÿ
            git remote set-url origin https://gh.xmly.dev/https://github.com/WayneXuCN/portfolio
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            git config --global --add safe.directory "$(pwd)"
            git fetch --all --depth=1
            git reset --hard origin/main
            git pull --depth=1

            # å®‰è£…ä¾èµ–å¹¶æ„å»º
            npm ci
            npm run build

            # è®¾ç½®æ–‡ä»¶æƒé™ä¸º PHP-FPM ç”¨æˆ·
            chown -R 1000:1000 .

            echo "âœ… å·²æˆåŠŸæ‹‰å– main åˆ†æ”¯æœ€æ–°å†…å®¹"
            echo "âœ… æ–‡ä»¶æƒé™å·²è®¾ç½®ä¸º 1000:1000"
            echo "ğŸš€ éƒ¨ç½²å®Œæˆæ—¶é—´: $(date)"
